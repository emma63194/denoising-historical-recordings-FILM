# Loss 收斂但效果差的原因分析

## 📊 訓練結果回顧

### 訓練指標（看起來很好）
- Epoch 1: Train MAE 0.343 → Val MAE 0.290
- Epoch 8: Train MAE 0.061 → Val MAE 0.117
- Loss 持續下降，無明顯過擬

### 實際效果（很糟糕）
- 降噪後振幅：只剩原始的 10%（0.003 vs 0.029）
- Residual 與原始相關性：0.998（幾乎一樣）
- **結論：模型把 90% 的訊號當成噪音移除了**

---

## 🔍 為什麼會這樣？

### 問題 1：SNR 範圍設定
```python
# dataset_loader.py 第 559 行
SNRs = np.random.uniform(2, 20)  # 訓練時 SNR 範圍
```

**這個設定的含義**：
- SNR 2 dB：噪音功率約為訊號的 63%（非常髒）
- SNR 20 dB：噪音功率約為訊號的 1%（非常乾淨）
- 平均 SNR ≈ 11 dB：噪音約為訊號的 12.6%

**計算公式**：
```
SNR (dB) = 10 * log10(P_signal / P_noise)
SNR 2 dB  → P_noise / P_signal = 0.63 (噪音是訊號的 63%)
SNR 11 dB → P_noise / P_signal = 0.126 (噪音是訊號的 12.6%)
SNR 20 dB → P_noise / P_signal = 0.01 (噪音是訊號的 1%)
```

### 問題 2：訓練數據生成方式
```python
# 第 583 行
summed = segment + sqrt(power_clean / (snr * power_noise)) * new_noise
```

**這行代碼做了什麼**：
1. 計算乾淨訊號功率：`power_clean = var(segment)`
2. 計算噪音功率：`power_noise = var(new_noise)`
3. 根據目標 SNR 縮放噪音
4. 加到乾淨訊號上：`noisy = clean + scaled_noise`

**訓練目標**：
- 輸入：`noisy = clean + noise`
- 輸出：`clean`
- Loss：`MAE(predicted_clean, true_clean)`

### 問題 3：Loss 優化的盲點

**MAE 在做什麼**：
```python
loss = mean(|predicted - target|)
```

模型學到的策略：
1. **策略 A（正確）**：學會識別並移除噪音，保留訊號
2. **策略 B（錯誤但 loss 也低）**：把所有東西都輸出成接近 0

**為什麼策略 B 的 loss 也會低？**

假設：
- Clean signal 平均振幅：0.029
- 如果模型輸出全 0：MAE ≈ 0.029
- 如果模型輸出 0.003：MAE 可能更低

**但這不是我們要的！** 我們要的是「有效的降噪」，不是「消音」！

---

## 🎯 根本問題：訓練與測試不匹配

### 訓練時的假設
1. 有乾淨的訊號
2. 人工加入已知的噪音（Gramophone）
3. SNR 在 2-20 dB 之間
4. 噪音特性：黑膠唱片的劈啪聲、底噪

### 測試時的現實
1. **真實老電影音檔**
2. 噪音可能完全不同：
   - 老電影膠片噪音
   - 磁帶嘶嘶聲
   - 機械噪音
   - 環境噪音
3. SNR 可能不在訓練範圍內
4. 訊號與噪音的頻譜特性不同

### 模型學到了什麼？

**正面解讀**：
- 模型學會了「Gramophone 噪音長什麼樣子」
- 遇到類似的噪音會移除

**負面解讀**：
- 模型過度依賴訓練數據的噪音特性
- 遇到不同的噪音，判斷錯誤
- **可能把真實訊號誤判為噪音**

---

## 💡 Loss 收斂代表什麼？

### 正確的理解

✅ Loss 收斂 = 模型學會了「在訓練數據分佈下」最小化誤差
❌ Loss 收斂 ≠ 模型在真實場景下有用
❌ Loss 收斂 ≠ 模型學到了正確的概念

### 類比說明

就像考試：
- **Loss 收斂** = 學生在「練習題」上拿高分
- **實際應用** = 學生在「真實考試」上的表現

如果練習題和真實考試：
- 題型不同 → 練習高分無用
- 難度不同 → 練習經驗失效
- 評分標準不同 → 高分策略錯誤

### 我們的情況

**訓練時**：
- 練習題：乾淨語音 + 人工 Gramophone 噪音
- 評分標準：預測的訊號與真實訊號的 MAE

**測試時**：
- 真實考試：老電影音檔（未知的乾淨部分 + 未知的噪音）
- 評分標準：聽起來是否自然、噪音是否降低

**不匹配點**：
1. 噪音類型不同
2. SNR 分佈可能不同
3. 訊號特性可能不同（訓練主要是語音，測試可能有音樂、音效）

---

## 🔧 解決方向

### 短期（修正推理）
1. **降低降噪強度**：混合原始訊號
   ```python
   output = 0.7 * original + 0.3 * denoised
   ```

2. **調整 SNR 偏好**：在推理時加入參數控制

### 中期（改善訓練）
1. **調整 SNR 範圍**：
   - 目前：`uniform(2, 20)` 平均 11 dB
   - 建議：`uniform(10, 25)` 平均 17.5 dB（更溫和的降噪）

2. **加入多樣化噪音**：
   - 不只 Gramophone
   - 加入白噪音、粉紅噪音
   - 加入真實電影音檔的噪音

3. **修改 Loss 函數**：
   - 不只用 MAE
   - 加入感知 Loss（STFT loss, perceptual loss）
   - 懲罰過度降噪

### 長期（重新設計）
1. **使用更好的架構**：
   - 條件式 U-Net（可控降噪強度）
   - 加入 attention mechanism
   - 使用 discriminator 判斷是否自然

2. **更好的評估指標**：
   - 不只看 MAE
   - SDR (Signal-to-Distortion Ratio)
   - PESQ (Perceptual Evaluation of Speech Quality)
   - 主觀評分

---

## 📝 總結

**Loss 收斂只代表**：
- 模型在訓練數據上學到了某種模式
- 按照定義的 Loss 函數，誤差最小化了

**Loss 收斂不代表**：
- 模型泛化到新數據
- 模型學到了「正確」的概念
- 模型在實際應用中有用

**關鍵教訓**：
1. 訓練數據要接近真實場景
2. Loss 函數要反映真實目標
3. 需要多種評估指標（不只一個 loss）
4. 定期在真實數據上測試

**我們的問題**：
- 用 Gramophone 噪音訓練
- 用老電影音檔測試
- 噪音特性不同 → 模型判斷錯誤 → 把訊號當噪音移除
